<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Screen Flickering Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        #console-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Fix Screen Flickering Test</h1>
        
        <div class="test-section">
            <h2>Test Screen Flickering Fix</h2>
            <p>Test the fix for infinite re-renders in exam-taking page</p>
            
            <button class="test-button" onclick="clearStorage()">1. Clear Storage</button>
            <button class="test-button" onclick="createMockAttempt()">2. Create Mock Attempt</button>
            <button class="test-button" onclick="testExamTaking()">3. Test Exam Taking</button>
            <button class="test-button" onclick="monitorConsole()">4. Monitor Console</button>
            
            <div id="result" class="result" style="display:none;"></div>
            <div id="console-output" style="display:none;"></div>
        </div>
    </div>

    <script>
        let consoleMonitor = null;
        let originalConsoleLog = null;

        function showResult(content, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = content;
        }

        function logToConsoleOutput(message) {
            const consoleDiv = document.getElementById('console-output');
            consoleDiv.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            consoleDiv.innerHTML += `[${timestamp}] ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function clearStorage() {
            showResult('Clearing sessionStorage...', 'info');
            sessionStorage.clear();
            logToConsoleOutput('sessionStorage cleared');
            showResult('‚úÖ sessionStorage cleared successfully', 'success');
        }

        function createMockAttempt() {
            showResult('Creating mock exam attempt...', 'info');
            
            const examId = '1';
            const mockAttemptId = Date.now();
            const title = 'Phuong Test';
            
            // Store mock data in sessionStorage
            sessionStorage.setItem('current_exam_id', examId);
            sessionStorage.setItem(`mock_attempt_${examId}`, JSON.stringify({
                examAttemptId: mockAttemptId,
                examId: parseInt(examId),
                startTime: new Date().toISOString(),
                questions: [
                    {
                        questionId: 1,
                        content: 'C√¢u h·ªèi 1: ƒê√¢y l√† n·ªôi dung c√¢u h·ªèi s·ªë 1?',
                        questionType: 'SingleChoice',
                        options: [
                            { optionId: 1, content: 'ƒê√°p √°n A cho c√¢u 1' },
                            { optionId: 2, content: 'ƒê√°p √°n B cho c√¢u 1' },
                            { optionId: 3, content: 'ƒê√°p √°n C cho c√¢u 1' },
                            { optionId: 4, content: 'ƒê√°p √°n D cho c√¢u 1' }
                        ]
                    },
                    {
                        questionId: 2,
                        content: 'C√¢u h·ªèi 2: ƒê√¢y l√† n·ªôi dung c√¢u h·ªèi s·ªë 2?',
                        questionType: 'SingleChoice',
                        options: [
                            { optionId: 5, content: 'ƒê√°p √°n A cho c√¢u 2' },
                            { optionId: 6, content: 'ƒê√°p √°n B cho c√¢u 2' },
                            { optionId: 7, content: 'ƒê√°p √°n C cho c√¢u 2' },
                            { optionId: 8, content: 'ƒê√°p √°n D cho c√¢u 2' }
                        ]
                    }
                ],
                title: title,
                durationMinutes: 60,
                endTime: new Date(Date.now() + 60 * 60 * 1000).toISOString()
            }));
            
            logToConsoleOutput(`Mock attempt created: ${mockAttemptId}`);
            logToConsoleOutput(`Exam ID: ${examId}`);
            logToConsoleOutput(`Title: ${title}`);
            
            showResult(`‚úÖ Mock attempt created successfully!\n\nAttempt ID: ${mockAttemptId}\nExam ID: ${examId}\nTitle: ${title}\n\nClick "Test Exam Taking" to open the exam page.`, 'success');
            
            return mockAttemptId;
        }

        function testExamTaking() {
            const mockAttemptId = createMockAttempt();
            
            showResult(`Opening exam-taking page with attempt ID: ${mockAttemptId}...`, 'info');
            
            // Open the exam-taking page
            const testWindow = window.open(`http://localhost:4000/exam-taking/phuong-test/${mockAttemptId}`, '_blank');
            
            setTimeout(() => {
                showResult(`‚úÖ Exam-taking page opened!\n\nIf the fix works correctly:\n- No screen flickering should occur\n- The page should load smoothly\n- Console logs should stop repeating\n- Check the new tab to verify`, 'success');
            }, 3000);
        }

        function monitorConsole() {
            if (consoleMonitor) {
                stopMonitoring();
                return;
            }
            
            showResult('Starting console monitoring...', 'info');
            originalConsoleLog = console.log;
            
            let messageCount = 0;
            const maxMessages = 50;
            
            console.log = function(...args) {
                messageCount++;
                if (messageCount <= maxMessages) {
                    const message = args.map(arg => 
                        typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                    ).join(' ');
                    logToConsoleOutput(message);
                }
                
                if (messageCount === maxMessages + 1) {
                    logToConsoleOutput('--- Too many messages, stopping log capture ---');
                }
                
                originalConsoleLog.apply(console, args);
            };
            
            consoleMonitor = true;
            document.querySelector('button[onclick="monitorConsole()"]').textContent = 'Stop Monitoring';
            
            showResult(`‚úÖ Console monitoring started!\n\nMonitoring up to ${maxMessages} messages.\nOpen the exam-taking page to see if the infinite loop is fixed.`, 'success');
        }

        function stopMonitoring() {
            if (originalConsoleLog) {
                console.log = originalConsoleLog;
            }
            consoleMonitor = false;
            document.querySelector('button[onclick="monitorConsole()"]').textContent = 'Monitor Console';
            showResult('Console monitoring stopped.', 'info');
        }

        // Add helpful information
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Screen Flickering Fix Test Page Loaded');
            console.log('üìù Fix Summary:');
            console.log('  - Added React.useCallback to memoize functions');
            console.log('  - Changed cacheTime from 0 to 5 minutes');
            console.log('  - Memoized getMockAttemptData function');
            console.log('  - Memoized service function to prevent re-renders');
            
            logToConsoleOutput('Test page loaded. Click the buttons to test the fix.');
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopMonitoring();
        });
    </script>
</body>
</html>